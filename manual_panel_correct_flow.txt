/*
=============== MANUAL PANEL CONTROL - FLOW YANG BENAR ===============

SKENARIO: Operator menekan push button K1 di panel

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MANUAL PANEL OPERATION FLOW                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ 1. Operator PRESS Button K1 (Pin 25)                               â”‚
â”‚    â†“                                                                â”‚
â”‚ 2. ESP32 detects: digitalRead(MANUAL_K1_BUTTON) == LOW             â”‚
â”‚    â†“                                                                â”‚
â”‚ 3. ESP32 executes: activateContractor(1)                           â”‚
â”‚    â†“                                                                â”‚
â”‚ 4. Relay NO1 = LOW (300ms pulse) â†’ Kontaktor 1 COIL energized      â”‚
â”‚    â†“                                                                â”‚
â”‚ 5. Kontaktor 1 main contacts CLOSE â†’ 220V to Lampu                 â”‚
â”‚    â†“                                                                â”‚
â”‚ 6. Lampu menyala â†’ Ada tegangan 220V di output                     â”‚
â”‚    â†“                                                                â”‚
â”‚ 7. Sensor tegangan (Pin 35) detect 220V â†’ voltage1Detected = HIGH  â”‚
â”‚    â†“                                                                â”‚
â”‚ 8. ESP32 update displays:                                          â”‚
â”‚    - Blynk.virtualWrite(V113, 1)  â† Button K1 di Blynk jadi ON     â”‚
â”‚    - Firebase status K1 = "ON"    â† Website monitor jadi HIJAU     â”‚
â”‚    - contactor1State = true                                        â”‚
â”‚    â†“                                                                â”‚
â”‚ 9. Operator RELEASE Button K1                                      â”‚
â”‚    â†“                                                                â”‚
â”‚10. ESP32 detects: digitalRead(MANUAL_K1_BUTTON) == HIGH            â”‚
â”‚    â†“                                                                â”‚
â”‚11. ESP32 executes: deactivateContractor(1)                         â”‚
â”‚    â†“                                                                â”‚
â”‚12. Relay NC1 = LOW (300ms pulse) â†’ Kontaktor 1 COIL de-energized   â”‚
â”‚    â†“                                                                â”‚
â”‚13. Kontaktor 1 main contacts OPEN â†’ No 220V to Lampu               â”‚
â”‚    â†“                                                                â”‚
â”‚14. Lampu mati â†’ Tidak ada tegangan di output                       â”‚
â”‚    â†“                                                                â”‚
â”‚15. Sensor tegangan detect no voltage â†’ voltage1Detected = LOW      â”‚
â”‚    â†“                                                                â”‚
â”‚16. ESP32 update displays:                                          â”‚
â”‚    - Blynk.virtualWrite(V113, 0)  â† Button K1 di Blynk jadi OFF    â”‚
â”‚    - Firebase status K1 = "OFF"   â† Website monitor jadi MERAH     â”‚
â”‚    - contactor1State = false                                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY POINTS:
===========
âœ… Manual panel button â†’ Physical kontaktor control
âœ… Kontaktor action â†’ Lampu on/off â†’ Sensor voltage change  
âœ… Sensor voltage â†’ Update Blynk button status
âœ… Sensor voltage â†’ Update website monitor color
âœ… Sinkronisasi penuh: Panel â†” Blynk â†” Website

IMPLEMENTATION LOGIC:
====================
*/

void checkManualPanelButtons() {
  if (!autoModeEnabled) {  // Manual panel mode
    
    // Manual K1 Button Control
    bool k1ButtonPressed = (digitalRead(MANUAL_K1_BUTTON) == LOW);
    if (k1ButtonPressed != manualK1Pressed) {
      manualK1Pressed = k1ButtonPressed;
      
      if (manualK1Pressed) {
        // BUTTON PRESSED â†’ KONTAKTOR ON
        Serial.println("ğŸ”´ MANUAL PANEL: K1 Button PRESSED");
        activateContractor(1);  // Kontaktor 1 energize
        // â†“ Kontaktor closes â†’ Lampu on â†’ Sensor will detect voltage
        // â†“ checkVoltageDetectors() akan update Blynk & Firebase
        
      } else {
        // BUTTON RELEASED â†’ KONTAKTOR OFF  
        Serial.println("âš« MANUAL PANEL: K1 Button RELEASED");
        deactivateContractor(1);  // Kontaktor 1 de-energize
        // â†“ Kontaktor opens â†’ Lampu off â†’ Sensor will detect no voltage
        // â†“ checkVoltageDetectors() akan update Blynk & Firebase
      }
    }
    
    // Manual K2 Button Control (sama logic)
    bool k2ButtonPressed = (digitalRead(MANUAL_K2_BUTTON) == LOW);
    if (k2ButtonPressed != manualK2Pressed) {
      manualK2Pressed = k2ButtonPressed;
      
      if (manualK2Pressed) {
        Serial.println("ğŸ”´ MANUAL PANEL: K2 Button PRESSED");
        activateContractor(2);
      } else {
        Serial.println("âš« MANUAL PANEL: K2 Button RELEASED"); 
        deactivateContractor(2);
      }
    }
  }
}

void checkVoltageDetectors() {
  // Sensor SELALU dibaca untuk update display
  voltage1Detected = digitalRead(sensor1) == HIGH;
  voltage2Detected = digitalRead(sensor2) == HIGH;

  Serial.printf("Sensors: S1=%s, S2=%s | Mode=%s\n",
               voltage1Detected ? "HIGH" : "LOW",
               voltage2Detected ? "LOW" : "LOW", 
               autoModeEnabled ? "AUTO" : "MANUAL");
  
  if (autoModeEnabled) {
    // ========== AUTO MODE: SENSOR â†’ KONTAKTOR CONTROL ==========
    // Sensor reading memicu kontaktor action
    
    if (!voltage1Detected && !contactor1State) {
      activateContractor(1);
      Serial.println("ğŸ¤– AUTO: Sensor1 LOW â†’ Activate K1");
    } else if (voltage1Detected && contactor1State) {
      deactivateContractor(1);
      Serial.println("ğŸ¤– AUTO: Sensor1 HIGH â†’ Deactivate K1");
    }
    
  } else {
    // ========== MANUAL MODE: SENSOR â†’ DISPLAY UPDATE ONLY ==========
    // Sensor reading TIDAK memicu kontaktor action
    // Tapi sensor tetap update display Blynk & Firebase
    
    Serial.println("ğŸ‘¤ MANUAL: Sensors for display only, buttons control contactors");
  }
  
  // ========== SENSOR â†’ DISPLAY UPDATE (SELALU AKTIF) ==========
  // Ini yang penting: sensor voltage â†’ update Blynk & website
  
  // Update Blynk button status berdasarkan KONTAKTOR STATE (bukan sensor)
  Blynk.virtualWrite(V113, contactor1State ? 1 : 0);  // K1 button status
  Blynk.virtualWrite(V114, contractor2State ? 1 : 0);  // K2 button status
  
  // Update Blynk sensor display
  Blynk.virtualWrite(V121, voltage1Detected ? 1 : 0);  // Sensor 1 reading
  Blynk.virtualWrite(V122, voltage2Detected ? 1 : 0);  // Sensor 2 reading
  
  // Update main switch
  bool mainState = contractor1State || contactor2State;
  Blynk.virtualWrite(V126, mainState ? 1 : 0);
  Blynk.virtualWrite(V112, mainState ? 1 : 0);
  
  // Update Firebase untuk website monitor
  updateFirebaseStatus();  // Website color berdasarkan kontaktor state
}

/*
HASIL AKHIR:
============

MANUAL PANEL MODE:
1. Press button K1 â†’ Kontaktor 1 ON â†’ Lampu nyala
2. Sensor detect voltage â†’ voltage1Detected = HIGH  
3. Blynk V113 button = ON (sinkron dengan panel)
4. Website K1 status = HIJAU (sinkron dengan panel)
5. Release button K1 â†’ Kontaktor 1 OFF â†’ Lampu mati
6. Sensor detect no voltage â†’ voltage1Detected = LOW
7. Blynk V113 button = OFF (sinkron dengan panel) 
8. Website K1 status = MERAH (sinkron dengan panel)

SINKRONISASI SEMPURNA:
ğŸ“± Blynk App â†” ğŸ›ï¸ Manual Panel â†” ğŸŒ Website Monitor

Operator bisa kontrol dari mana saja:
- Panel fisik â†’ update ke Blynk & Website
- Blynk app â†’ update ke Panel & Website  
- Website â†’ update ke Panel & Blynk
*/